name: "ðŸš€ Auto-Increment & Release"

on:
  workflow_dispatch:

env:
  ks_filename: release_keystore.jks
  ks_store_pass: ${{ secrets.KS_STORE_PASS }}
  ks_alias: ${{ secrets.KS_ALIAS }}
  ks_alias_pass: ${{ secrets.KS_ALIAS_PASS }}

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Decode Keystore
        run: echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > ${{ env.ks_filename }}

      - name: Change Gradle Wrapper Permissions
        run: chmod +x ./gradlew

      # 1. READ version.txt AND INJECT into build.gradle.kts
      - name: Read and Inject Version
        id: version_info
        run: |
          VERSION_FILE="version.txt"
          
          if [ ! -f "$VERSION_FILE" ]; then
            echo "Error: $VERSION_FILE not found! Please create it with version code on line 1 and name on line 2."
            exit 1
          fi

          # Read values exactly as they are in the file
          VERSION_CODE=$(sed -n '1p' "$VERSION_FILE" | tr -d '\r' | xargs)
          VERSION_NAME=$(sed -n '2p' "$VERSION_FILE" | tr -d '\r' | xargs)

          echo "Using Version Name: $VERSION_NAME"
          echo "Using Version Code: $VERSION_CODE"
          
          # 2. INJECT variables into the defaultConfig block
          # This finds the line containing 'defaultConfig {' and appends the hardcoded 
          # version assignments immediately after it. 
          find . -name "build.gradle.kts" | while read file; do
            echo "Processing $file..."
          
            # First, remove any existing versionCode or versionName lines to avoid duplicates
            sed -i '/versionCode[[:space:]]*=[[:space:]]*/d' "$file"
            sed -i '/versionName[[:space:]]*=[[:space:]]*/d' "$file"
          
            # Now, inject the new hardcoded values right after 'defaultConfig {'
            sed -i "/defaultConfig[[:space:]]*{/a \        versionCode = $VERSION_CODE\n        versionName = \"$VERSION_NAME\"" "$file"
          done

          # Export for later steps
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT

      # 3. COMMIT, TAG & PUSH
      # Commits the "stamped" build files so the tag contains the hardcoded versions
      - name: Commit, Tag & Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          
          TAG_NAME="v${{ steps.version_info.outputs.version_name }}"
          git commit -m "chore: prepare release $TAG_NAME (${{ steps.version_info.outputs.version_code }})" || echo "No changes to commit"
          
          # Tag the specific commit with the updated build files
          git tag -f "$TAG_NAME"
          git push origin main
          git push origin "$TAG_NAME" --force

      # 4. DETECTION
      - name: Detect App Modules
        run: |
          # Detect modules by searching for the versionCode we just injected
          MODULES=$(grep -rl "versionCode" . --include="build.gradle.kts" | awk -F/ '{print $(NF-1)}' | grep -vE "^\.$" | sort -u | tr '\n' ' ')
          echo "Detected modules: $MODULES"
          echo "modules=$MODULES" >> $GITHUB_ENV

      - name: Download Bundletool
        run: |
          mkdir -p .github/lib
          curl -L https://github.com/google/bundletool/releases/download/1.17.2/bundletool-all-1.17.2.jar -o .github/lib/bundletool.jar

      # 5. BUILD & SIGN
      - name: Build and Sign
        run: |
          mkdir -p distribution_apks
          for module in ${{ env.modules }}; do
            echo "Building: $module"
            ./gradlew :$module:bundleRelease
          
            java -jar ".github/lib/bundletool.jar" build-apks \
              --bundle=$module/build/outputs/bundle/release/$module-release.aab \
              --output=$module/build/outputs/bundle/release/$module.apks \
              --mode=universal \
              --ks="${{ env.ks_filename }}" \
              --ks-pass=pass:${{ env.ks_store_pass }} \
              --ks-key-alias=${{ env.ks_alias }} \
              --key-pass=pass:${{ env.ks_alias_pass }}
          
            unzip -p $module/build/outputs/bundle/release/$module.apks universal.apk > distribution_apks/$module-release.apk
          done

      # 6. CREATE RELEASE
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.version_info.outputs.version_name }}"
          name: "Release ${{ steps.version_info.outputs.version_name }}"
          body: |
            Automated manual release.
            Version Name: ${{ steps.version_info.outputs.version_name }}
            Version Code: ${{ steps.version_info.outputs.version_code }}
          files: distribution_apks/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}