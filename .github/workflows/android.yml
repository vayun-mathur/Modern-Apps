name: "ðŸš€ Auto-Increment & Release"

on:
  workflow_dispatch:
    inputs:
      version_name:
        description: 'New Version Name (e.g. v2.0)'
        required: true
        default: 'v1.0'

env:
  ks_filename: release_keystore.jks
  ks_store_pass: ${{ secrets.KS_STORE_PASS }}
  ks_alias: ${{ secrets.KS_ALIAS }}
  ks_alias_pass: ${{ secrets.KS_ALIAS_PASS }}

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Decode Keystore
        run: echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > ${{ env.ks_filename }}

      - name: Change Gradle Wrapper Permissions
        run: chmod +x ./gradlew

      # 1. CLEAN VERSION BUMP (Handles both Groovy and Kotlin DSL)
      - name: Bump Version Name and Code
        run: |
          NEW_NAME="${{ github.event.inputs.version_name }}"
          echo "Updating to Version Name: $NEW_NAME"
          
          find . -name "build.gradle*" | while read file; do
            # Update versionName
            sed -i "s/versionName\([[:space:]]*=[[:space:]]*\|[[:space:]]*\)\"[^\"]*\"/versionName\1\"$NEW_NAME\"/g" "$file"
          
            # Increment versionCode
            CURRENT_CODE=$(grep -E "versionCode\s*(=?)\s*[0-9]+" "$file" | sed 's/[^0-9]*//g' | head -1)
            if [ ! -z "$CURRENT_CODE" ]; then
              NEXT_CODE=$((CURRENT_CODE + 1))
              sed -i "s/versionCode\([[:space:]]*=[[:space:]]*\|[[:space:]]*\)$CURRENT_CODE/versionCode\1$NEXT_CODE/g" "$file"
            fi
          done

      # 2. COMMIT CHANGES
      - name: Commit & Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore: bump version to ${{ github.event.inputs.version_name }}" || echo "No changes to commit"
          git push

      # 3. ROBUST APP MODULE DETECTION (Fixed the syntax error issue)
      - name: Detect App Modules
        run: |
          # 1. Grep for the plugin
          # 2. Get the directory (module name)
          # 3. Filter out the root '.' and clean up characters
          MODULES=$(grep -rE "com.android.application" . --include="build.gradle*" | awk -F/ '{print $2}' | grep -v "build.gradle" | sort -u | tr '\n' ' ')
          echo "Detected clean modules: $MODULES"
          echo "modules=$MODULES" >> $GITHUB_ENV

      - name: Download Bundletool
        run: |
          mkdir -p .github/lib
          curl -L https://github.com/google/bundletool/releases/download/1.17.2/bundletool-all-1.17.2.jar -o .github/lib/bundletool.jar

      # 4. BUILD & SIGN (Using the cleaned module list)
      - name: Build and Sign
        run: |
          mkdir -p distribution_apks
          for module in ${{ env.modules }}; do
            echo "Building module: $module"
            ./gradlew :$module:bundleRelease
          
            java -jar ".github/lib/bundletool.jar" build-apks \
              --bundle=$module/build/outputs/bundle/release/$module-release.aab \
              --output=$module/build/outputs/bundle/release/$module.apks \
              --mode=universal \
              --ks="${{ env.ks_filename }}" \
              --ks-pass=pass:${{ env.ks_store_pass }} \
              --ks-key-alias=${{ env.ks_alias }} \
              --key-pass=pass:${{ env.ks_alias_pass }}
          
            unzip -p $module/build/outputs/bundle/release/$module.apks universal.apk > distribution_apks/$module-release.apk
          done

      # 5. CREATE RELEASE & TAG
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version_name }}
          name: "Release ${{ github.event.inputs.version_name }}"
          body: "Automated release for version ${{ github.event.inputs.version_name }}. VersionCode has been auto-incremented."
          files: distribution_apks/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}