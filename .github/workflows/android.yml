name: "ðŸš€ Auto-Increment & Release"

on:
  workflow_dispatch:

env:
  ks_filename: release_keystore.jks
  ks_store_pass: ${{ secrets.KS_STORE_PASS }}
  ks_alias: ${{ secrets.KS_ALIAS }}
  ks_alias_pass: ${{ secrets.KS_ALIAS_PASS }}

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Clean Project Files
        run: |
          if [ -f "settings.gradle.kts" ]; then
            echo "Removing local includeBuild from settings.gradle.kts..."
            sed -i '/includeBuild.*NewPipeExtractor/,/^}/d' settings.gradle.kts
          fi

          if [ -f "build.gradle.kts" ]; then
            echo "Removing debug signingConfig from root build.gradle.kts..."
            sed -i '/signingConfig = signingConfigs.getByName("debug")/d' build.gradle.kts
          fi

      - name: Decode Keystore
        run: echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > ${{ env.ks_filename }}

      - name: Change Gradle Wrapper Permissions
        run: chmod +x ./gradlew

      - name: Read and Inject Version
        id: version_info
        run: |
          VERSION_FILE="version.txt"
          if [ ! -f "$VERSION_FILE" ]; then
            echo "Error: $VERSION_FILE not found!"
            exit 1
          fi

          VERSION_CODE=$(sed -n '1p' "$VERSION_FILE" | tr -d '\r' | xargs)
          VERSION_NAME=$(sed -n '2p' "$VERSION_FILE" | tr -d '\r' | xargs)

          echo "Using Version Name: $VERSION_NAME"
          echo "Using Version Code: $VERSION_CODE"
          
          find . -mindepth 2 -name "build.gradle.kts" | while read file; do
            sed -i '/versionCode[[:space:]]*=[[:space:]]*/d' "$file"
            sed -i '/versionName[[:space:]]*=[[:space:]]*/d' "$file"
            sed -i "/defaultConfig[[:space:]]*{/a \        versionCode = $VERSION_CODE\n        versionName = \"$VERSION_NAME\"" "$file"
          done

          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT

      - name: Detect App Modules
        run: |
          # Detect modules, excluding root and youpipe
          MODULE_DIRS=$(grep -rl "versionCode" . --include="build.gradle.kts" | \
            grep -vE "^\./build.gradle.kts$|youpipe" | \
            sed 's|^\./||; s|/build.gradle.kts$||' | sort -u | tr '\n' ' ')
          
          echo "Detected modules: $MODULE_DIRS"
          echo "module_dirs=$MODULE_DIRS" >> $GITHUB_ENV

      - name: Prepare F-Droid Metadata
        run: |
          for dir in ${{ env.module_dirs }}; do
            # Convert dir path to hyphenated module name for file matching
            # e.g. games/chess -> games-chess
            module_key=$(echo $dir | sed 's|/|-|g')
            target_path="$dir/src/main/play/listings/en-US"
          
            echo "Preparing metadata for $module_key in $target_path"
            mkdir -p "$target_path/graphics/icons"
            mkdir -p "$target_path/graphics/phone-screenshots"
          
            # Copy Play Store icon
            icon_source="$dir/src/main/ic_launcher-playstore.png"
            if [ -f "$icon_source" ]; then
              cp "$icon_source" "$target_path/graphics/icons/icon.png"
            fi
          
            # Copy Phone Screenshots from metadata_data/photos/{module_key}.png
            screenshot_source="metadata_data/photos/${module_key}.png"
            if [ -f "$screenshot_source" ]; then
              cp "$screenshot_source" "$target_path/graphics/phone-screenshots/1.png"
            fi
          
            # Use a single source file named {module_key}.md (using hyphens)
            metadata_src="metadata_data/${module_key}.md"
          
            if [ -f "$metadata_src" ]; then
              # Extract first line for short description
              head -n 1 "$metadata_src" > "$target_path/short-description.txt"
              # Full description is the whole file (including first line)
              cp "$metadata_src" "$target_path/full-description.txt"
            else
              echo "Warning: Metadata source $metadata_src not found."
            fi
          done

      - name: Commit, Tag & Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          TAG_NAME="${{ steps.version_info.outputs.version_name }}"
          git commit -m "chore: prepare release $TAG_NAME (${{ steps.version_info.outputs.version_code }})" || echo "No changes to commit"
          
          git tag -f "$TAG_NAME"
          git push origin "$TAG_NAME" --force

      - name: Build and Sign
        run: |
          mkdir -p distribution_apks
          for dir in ${{ env.module_dirs }}; do
            gradle_path=$(echo $dir | sed 's|/|:|g')
            module_name=$(basename $dir)
          
            echo "--------------------------------------------"
            echo "Building and Signing: $gradle_path"
            echo "--------------------------------------------"
          
            ./gradlew :$gradle_path:assembleRelease \
              -Pandroid.enableResourceOptimizations=true \
              -Pandroid.enableR8.fullMode=true \
              -PRELEASE_STORE_FILE="${{ github.workspace }}/${{ env.ks_filename }}" \
              -PRELEASE_STORE_PASSWORD="${{ env.ks_store_pass }}" \
              -PRELEASE_KEY_ALIAS="${{ env.ks_alias }}" \
              -PRELEASE_KEY_PASSWORD="${{ env.ks_alias_pass }}"
          
            cp $dir/build/outputs/apk/release/*.apk distribution_apks/ || echo "No APK found for $module_name"
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ steps.version_info.outputs.version_name }}"
          name: "Release ${{ steps.version_info.outputs.version_name }}"
          body: |
            Automated multi-module release.
            Version Name: ${{ steps.version_info.outputs.version_name }}
            Version Code: ${{ steps.version_info.outputs.version_code }}
          files: distribution_apks/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}