name: Build Specific Module APKs

env:
  # MANUAL LIST: Add or remove modules here as needed
  modules: "calendar contacts"
  
  # Temporary filename for the decoded keystore
  ks_filename: release_keystore.jks
  
  # Credentials pulled from GitHub Secrets
  ks_store_pass: ${{ secrets.KS_STORE_PASS }}
  ks_alias: ${{ secrets.KS_ALIAS }}
  ks_alias_pass: ${{ secrets.KS_ALIAS_PASS }}

on:
  push:
    branches:
      - 'release/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Decode Keystore from Secret
        run: echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > ${{ env.ks_filename }}

      - name: Change Gradle Wrapper Permissions
        run: chmod +x ./gradlew

      - name: Download Bundletool
        run: |
          mkdir -p .github/lib
          curl -L https://github.com/google/bundletool/releases/download/1.17.2/bundletool-all-1.17.2.jar -o .github/lib/bundletool.jar

      - name: Build and Sign Loop
        run: |
          mkdir -p distribution_apks
          # Iterates through the space-separated list in env.modules
          for module in ${{ env.modules }}; do
            echo "--------------------------------------------"
            echo "Building Module: $module"
            echo "--------------------------------------------"
            
            # 1. Build the App Bundle (AAB)
            ./gradlew :$module:bundleRelease
            
            # 2. Convert AAB to Universal Signed APK using Bundletool
            java -jar ".github/lib/bundletool.jar" build-apks \
              --bundle=$module/build/outputs/bundle/release/$module-release.aab \
              --output=$module/build/outputs/bundle/release/$module.apks \
              --mode=universal \
              --ks="${{ env.ks_filename }}" \
              --ks-pass=pass:${{ env.ks_store_pass }} \
              --ks-key-alias=${{ env.ks_alias }} \
              --key-pass=pass:${{ env.ks_alias_pass }}
            
            # 3. Extract and rename: module_name-release.apk
            unzip -p $module/build/outputs/bundle/release/$module.apks universal.apk > distribution_apks/$module-release.apk
          done

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Signed-Release-APKs
          path: distribution_apks/
